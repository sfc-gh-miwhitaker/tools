![Reference Implementation](https://img.shields.io/badge/Reference-Implementation-blue)
![Snowflake](https://img.shields.io/badge/Snowflake-29B5E8?style=flat&logo=snowflake&logoColor=white)
![React](https://img.shields.io/badge/React-61DAFB?style=flat&logo=react&logoColor=black)
![Expires](https://img.shields.io/badge/Expires-2026--01--14-orange)

# Cortex Agent Chat - React Integration Example

> **DEMONSTRATION PROJECT - EXPIRES: 2026-01-14**  
> This demo uses Snowflake features current as of December 2024.  
> After expiration, this repository will be archived and made private.

**Author:** SE Community  
**Purpose:** Reference implementation showing React.js integration with Snowflake Cortex Agents  
**Created:** 2025-12-15 | **Expires:** 2026-01-14 (30 days) | **Status:** ACTIVE

---

## âš ï¸ Important Context

**This project is intentionally NOT 100% Snowflake-native.**

Unlike typical tools in this repository (which use Streamlit, Snowflake notebooks, or pure SQL), this example demonstrates how to integrate Snowflake Cortex Agents into an **external React.js application**.

**Use this project when you need to:**
- Build a custom web UI outside Snowflake
- Integrate Cortex Agents into existing React applications
- Understand REST API patterns for Cortex Agents
- Implement key-pair JWT authentication in JavaScript

**For native Snowflake chat interfaces, use:**
- Snowflake Cortex Analyst built-in UI
- Streamlit applications (Python-based)
- Snowflake Notebooks with interactive widgets

---

## Overview

A modern, single-page React application that provides a chat interface for Snowflake Cortex Agents using the REST API with secure key-pair JWT authentication.

**Key Features:**
- ğŸ¨ Snowflake-branded UI (cyan #29B5E8 color palette)
- ğŸ” Key-pair JWT authentication (no expiring tokens to manage)
- ğŸ’¬ Real-time streaming responses via Server-Sent Events
- âš¡ Auto-refreshing JWT tokens (1-hour lifetime)
- ğŸ§© Simple, production-ready React patterns

## ğŸ”’ Security Warning

**Private key stays on the backend proxy.** The React app never receives or stores the RSA private key. JWT signing happens in the local Node.js/Express proxy (`server/index.js`), which forwards requests to Snowflake.

**âš ï¸ Still demo-only:** The included backend is lightweight and not hardened for production. For production:
1. Keep the private key in a secure server-side secret store (vault/KMS/env var).
2. Lock down the backend with auth and TLS (reverse proxy / API gateway).
3. Enforce least-privilege Snowflake roles for the service user.
4. Rotate keys regularly and monitor REST usage.

**Technology Stack:**
- React.js (UI framework)
- Node.js + Express (backend proxy)
- Snowflake Cortex Agents (AI backend)
- RSA key-pair authentication (no password or PAT tokens)

---

## Snowflake Features Demonstrated

- **Cortex Agents** - AI-powered conversational agents
- **REST API** - Programmatic access via `/api/v2/databases/.../agents/:run`
- **Key-Pair JWT Authentication** - Secure, long-lived asymmetric authentication
- **Server-Sent Events (SSE)** - Real-time streaming responses
- **External Integration** - React web app as external consumer

### Requirements

- **ACCOUNTADMIN role** - Required to grant CORTEX_AGENT_USER database role
- **Cortex Agents availability** - Feature must be available in your Snowflake region
- **OpenSSL** - For generating RSA key-pair (usually pre-installed on macOS/Linux)

---

## ğŸ‘‹ First Time Here?

Follow these steps to get the chat interface running:

### âš¡ Quick Setup (Automated - Recommended)

**Step 1: Run Setup Script (1 minute)**

```bash
# macOS/Linux
cd tools/cortex-agent-chat
./tools/01_setup.sh

# Windows
cd tools\cortex-agent-chat
tools\01_setup.bat
```

This script will:
- âœ… Generate RSA key-pair (rsa_key.pem, rsa_key.pub)
- âœ… Create `.env.server.local` (backend, holds private key) and `.env.local` (frontend, no secrets)
- âœ… Generate `deploy_with_key.sql` combining all SQL steps
- âœ… Output clear next steps

**Step 2: Update Account Name (30 seconds)**

```bash
# Edit .env.server.local (backend) and .env.local (frontend) to set your account
nano .env.server.local
nano .env.local

# Example:
SNOWFLAKE_ACCOUNT=xy12345.us-east-1      # set once; copy same value to frontend
REACT_APP_SNOWFLAKE_ACCOUNT=xy12345.us-east-1  # mirror of SNOWFLAKE_ACCOUNT
```

**Step 3: Deploy to Snowflake (2 minutes)**

```sql
-- Copy deploy_with_key.sql (generated by setup script) into Snowsight â†’ Run All
-- This script:
-- âœ“ Creates the demo Cortex Agent (SFE_REACT_DEMO_AGENT)
-- âœ“ Assigns your public key to your user
-- âœ“ Verifies key assignment
```

**Step 4: Start Application (1 minute)**

```bash
# Install dependencies and start backend + frontend together
npm install
npm run dev

# Backend: http://localhost:4000
# Frontend: http://localhost:3001
```

**Total setup time: ~5 minutes** âš¡

---

### ğŸ”§ Manual Setup (Step-by-Step Alternative)

<details>
<summary>Click to expand manual setup instructions</summary>

### Step 1: Run Shared Setup (First Time Only)

```sql
-- Copy shared/sql/00_shared_setup.sql into Snowsight â†’ Run All
-- (Creates SNOWFLAKE_EXAMPLE database and SFE_SHARED_WH warehouse)
```

### Step 2: Generate RSA Key-Pair

```bash
# Generate 2048-bit RSA private key
openssl genrsa -out rsa_key.pem 2048

# Extract public key
openssl rsa -in rsa_key.pem -pubout -out rsa_key.pub
```

### Step 3: Deploy Cortex Agent

```sql
-- Copy deploy.sql into Snowsight â†’ Run All
-- (Creates SFE_REACT_DEMO_AGENT)
```

### Step 4: Assign Public Key to User

```sql
-- In Snowsight:
USE ROLE ACCOUNTADMIN;

-- Copy public key content (without BEGIN/END lines)
ALTER USER your_username SET RSA_PUBLIC_KEY='MIIBIjANBgkqhki...';

-- Verify
DESC USER your_username;
```

### Step 5: Create environment files

```bash
cp server.env.example .env.server.local   # backend (holds private key)
cp env.example .env.local                 # frontend (no secrets)

# Edit both files to set your account; place the private key ONLY in .env.server.local
```

### Step 6: Start Application

```bash
npm install
npm run dev   # starts backend :4000 and frontend :3001
```

**Total setup time: ~15 minutes**

</details>

---

### ğŸ¯ What Happens Next?

1. **App loads** with configuration from `.env.local` (frontend, non-secret)
2. **Backend proxy** reads `.env.server.local`, signs key-pair JWTs, and talks to Snowflake
3. **Thread created automatically**; parent_message_id tracked from Snowflake `metadata` events
4. **Chat interface** streams responses in real time

**Ready to chat!** Try: "What can you help me with?"

---

## Snowflake Objects Created

| Object Type | Fully Qualified Name | Purpose |
|-------------|---------------------|---------|
| Schema | `SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT` | Project namespace |
| Cortex Agent | `SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT.SFE_REACT_DEMO_AGENT` | Demo conversational agent |

**Shared Infrastructure (created by `shared/sql/00_shared_setup.sql`):**
- Database: `SNOWFLAKE_EXAMPLE`
- Warehouse: `SFE_SHARED_WH` (XS, auto-suspend 60s)
- Schema: `SNOWFLAKE_EXAMPLE.SEMANTIC_MODELS` (for semantic views)

**User Configuration:**
- RSA public key assigned to your Snowflake user (via `ALTER USER`)

---

## Architecture

### High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŒ User's Browser (localhost:3001)                                   â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ React Application (Snowflake-branded UI)                       â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  1. User types message                                         â”‚ â”‚
â”‚  â”‚  2. UI calls backend proxy (/api/threads, /api/agent/run)      â”‚ â”‚
â”‚  â”‚  3. Streams responses via SSE from proxy                       â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  Components:                                                    â”‚ â”‚
â”‚  â”‚  â€¢ ChatInterface (UI)                                          â”‚ â”‚
â”‚  â”‚  â€¢ snowflakeApi.js (calls local backend)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ HTTP (localhost:4000)
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš€ Backend Proxy (Express, localhost:4000)                          â”‚
â”‚  â€¢ Signs KEYPAIR_JWT with private key from .env.server.local        â”‚
â”‚  â€¢ POST /api/threads â†’ Snowflake /api/v2/cortex/threads            â”‚
â”‚  â€¢ POST /api/agent/run(+/stream) â†’ Snowflake agent:run             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ HTTPS (TLS)
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â„ï¸  Snowflake Account                                                â”‚
â”‚  â€¢ Validates KEYPAIR_JWT (public key on user)                       â”‚
â”‚  â€¢ Runs Cortex Agent: SFE_REACT_DEMO_AGENT                          â”‚
â”‚  â€¢ Streams SSE events (metadata, deltas, response)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Security Properties:**
- ğŸ” Private key stays server-side (.env.server.local); never in the browser
- ğŸ”‘ JWT tokens signed in the backend proxy; frontend sees only thread/message data
- â° Tokens auto-refreshed server-side (1h default)
- ğŸ”’ Snowflake validates signature against stored public key

See `diagrams/` for detailed sequence diagrams (auth-flow, data-flow, network-flow).

---

## API Integration Details

### Backend API Surface (what the React app calls)

- `POST /api/threads`  
  Creates a Snowflake thread (proxies to `/api/v2/cortex/threads`). Returns `{ thread_id }`.

- `POST /api/agent/run`  
  Non-streaming agent call (proxies to `/api/v2/databases/{db}/schemas/{schema}/agents/{agent}:run`).

- `POST /api/agent/run/stream`  
  Streaming agent call (SSE) to the same Snowflake endpoint; forwards Snowflake SSE events to the browser.

### Sample streaming request (to backend)

```http
POST /api/agent/run/stream
Content-Type: application/json

{
  "threadId": 12345,
  "parentMessageId": 0,
  "message": "What are the top 5 customers by revenue?"
}
```

### Streaming response (from backend â†’ browser)

```
event: metadata
data: {"role":"assistant","message_id":456}

event: response.text.delta
data: {"delta":"Based on the data, "}

event: response.text.delta
data: {"delta":"the top 5 customers are ..."}

event: response.completed
data: {"text":"Based on the data, the top 5 customers are ..."}
```

### Key-Pair JWT Authentication (server-side)

- **Signer location:** `server/index.js` (Express) using the private key from `.env.server.local`.
- **Algorithm:** RS256; issuer includes the public key fingerprint per Snowflake requirements.
- **Headers sent to Snowflake:**  
  `Authorization: Bearer <KEYPAIR_JWT>`  
  `X-Snowflake-Authorization-Token-Type: KEYPAIR_JWT`
- **Token lifetime:** 1 hour; cached and refreshed in the backend proxy.
- **Security:** Private key never leaves the backend; Snowflake validates the signature against the userâ€™s stored public key.

---

## Project Structure

```
cortex-agent-chat/
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ 01_setup.sh                # âš¡ Automated setup (macOS/Linux)
â”‚   â”‚                              #    - Generates RSA key-pair
â”‚   â”‚                              #    - Creates .env.server.local (backend secrets) + .env.local (frontend)
â”‚   â”‚                              #    - Generates deploy_with_key.sql
â”‚   â””â”€â”€ 01_setup.bat               # âš¡ Automated setup (Windows)
â”œâ”€â”€ server/
â”‚   â””â”€â”€ index.js                   # ğŸš€ Express backend proxy (KEYPAIR_JWT signer + Snowflake proxy)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ChatInterface.js       # ğŸ’¬ Main chat container (Snowflake-branded header)
â”‚   â”‚   â”œâ”€â”€ ChatInterface.css      # ğŸ¨ Snowflake cyan (#29B5E8) styling
â”‚   â”‚   â”œâ”€â”€ ThinkingIndicator.js   # â„ï¸  "Agent is thinking" animation
â”‚   â”‚   â”œâ”€â”€ ConfigPanel.js         # âš™ï¸  Configuration form (key-pair setup)
â”‚   â”‚   â”œâ”€â”€ MessageList.js         # ğŸ“œ Message display container
â”‚   â”‚   â”œâ”€â”€ MessageInput.js        # âŒ¨ï¸  User input field
â”‚   â”‚   â””â”€â”€ Message.js             # ğŸ’¬ Individual message bubble
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ jwtGenerator.js        # (legacy) Client-side JWT generator (not used; backend signs now)
â”‚   â”‚   â””â”€â”€ snowflakeApi.js        # ğŸŒ Client â†’ backend proxy (threads + agent:run, SSE)
â”‚   â”œâ”€â”€ App.js                     # ğŸ  Root component
â”‚   â”œâ”€â”€ App.css                    # ğŸ¨ Global Snowflake color variables
â”‚   â””â”€â”€ index.js                   # ğŸš€ React entry point
â”œâ”€â”€ diagrams/
â”‚   â”œâ”€â”€ auth-flow.md               # ğŸ“Š Key-pair JWT authentication diagram
â”‚   â”œâ”€â”€ data-flow.md               # ğŸ“Š Message flow diagram
â”‚   â””â”€â”€ network-flow.md            # ğŸ“Š Network architecture
â”œâ”€â”€ deploy.sql                     # â„ï¸  Snowflake setup (agent creation)
â”œâ”€â”€ teardown.sql                   # ğŸ§¹ Cleanup script
â”œâ”€â”€ env.example                    # ğŸ“‹ Template for .env.local (frontend, non-secret)
â”œâ”€â”€ server.env.example             # ğŸ“‹ Template for .env.server.local (backend, holds private key)
â”œâ”€â”€ .gitignore                     # ğŸš« Excludes .env*, *.pem, *.key
â””â”€â”€ README.md                      # ğŸ“– This file
```

**Generated Files (by setup script, gitignored):**
- `rsa_key.pem` - Private key (2048-bit RSA)
- `rsa_key.pub` - Public key
- `.env.server.local` - Backend config with private key (do not commit)
- `.env.local` - Frontend config (non-secret)
- `deploy_with_key.sql` - Combined SQL (deploy + key assignment)

**Key Files to Understand:**

| File | Purpose | Key Concept |
|------|---------|-------------|
| `server/index.js` | Backend proxy + KEYPAIR_JWT signing | Signs JWTs server-side; proxies to Snowflake |
| `snowflakeApi.js` | Client â†’ backend proxy calls | Threads + agent:run (+ streaming) |
| `jwtGenerator.js` | (Legacy) Client-side signing reference | Kept for reference; not used in flow |
| `ChatInterface.js` | Main UI component | Manages chat state, displays messages |
| `ThinkingIndicator.js` | Loading animation | Visual feedback during agent processing |
| `App.css` | Global styles | Snowflake color palette (cyan, charcoal, white) |
| `deploy.sql` | Snowflake setup | Creates `SFE_REACT_DEMO_AGENT` Cortex Agent |

---

## Local Development

### Available Scripts

```bash
npm install         # Install dependencies
npm run dev         # Start backend (:4000) + frontend (:3001) concurrently
npm run server      # Start backend proxy only
npm start           # Start frontend only (expects backend already running)
npm run build       # Create production build of the frontend
npm test            # Run test suite (if tests added)
```

### UI Customization

**Snowflake Brand Colors (CSS Variables):**
```css
:root {
  --sf-cyan: #29B5E8;          /* Primary brand color */
  --sf-cyan-dark: #1E88C7;     /* Hover states */
  --sf-cyan-light: #E3F5FC;    /* Backgrounds */
  --sf-charcoal: #2D3E50;      /* Dark text */
  --sf-gray: #6B7785;          /* Secondary text */
  --sf-white: #FFFFFF;         /* Backgrounds */
}
```

**Customization Points:**
- Modify `src/App.css` for global theme changes
- Edit component CSS files for specific element styling
- All colors use CSS variables for easy theme switching
- Responsive design included (mobile-friendly)

---

## Testing & Validation

### Quick Verification (After Running Setup Script)

If you used `tools/01_setup.sh` (recommended), the script already created your keys and env files. Verify they exist:

```bash
# Check key files and backend env
ls -l rsa_key.pem rsa_key.pub .env.server.local .env.local
# Should see rsa_key.pem (private), rsa_key.pub (public), .env.server.local (backend, has private key), .env.local (frontend, no secrets)

# Sanity check private key present only in backend env
grep SNOWFLAKE_PRIVATE_KEY_PEM .env.server.local
grep SNOWFLAKE_PRIVATE_KEY_PEM .env.local   # should return nothing
```

### Test Key-Pair Authentication

Before running the app, you can verify your key-pair setup with Snow CLI (optional):

```bash
# Test Snowflake connection with key-pair
snow connection test \
  --account xy12345.us-east-1 \
  --user YOUR_USERNAME \
  --private-key-path rsa_key.pem

# Expected output:
# âœ… Connection successful!
```

### Verify Agent Exists

```sql
-- In Snowsight:
USE ROLE ACCOUNTADMIN;
USE DATABASE SNOWFLAKE_EXAMPLE;
USE SCHEMA SFE_CORTEX_AGENT_CHAT;

-- List agents
SHOW AGENTS;

-- Describe agent
DESC CORTEX AGENT SFE_REACT_DEMO_AGENT;
```

### Check Public Key Assignment

```sql
-- Verify public key fingerprint
DESC USER YOUR_USERNAME;

-- Look for:
-- RSA_PUBLIC_KEY_FP: SHA256:abc123... (should be populated)
```

### Test REST API Directly (Optional)

```bash
# Generate JWT token (requires jq and openssl)
# See scripts/describe-agent.sh for full example

# Or test via React app - easier!
npm start
```

---

## Troubleshooting

### ğŸ”´ Error: 401 Unauthorized

**Symptoms:**
- Browser console shows: `Error: 401 Unauthorized`
- Chat interface can't connect to agent

**Common Causes & Fixes:**

| Cause | How to Fix |
|-------|------------|
| **Public key not assigned** | Run `DESC USER <username>;` - check `RSA_PUBLIC_KEY_FP` is populated |
| **Wrong account format** | Use `xy12345.us-east-1` not `xy12345` or full URL |
| **Username mismatch** | `.env.local` username must match Snowflake user with public key |
| **Invalid private key format** | Ensure PEM format with `-----BEGIN PRIVATE KEY-----` header |
| **Key-pair mismatch** | Public key in Snowflake must match private key in `.env.local` |

**Diagnostic Steps:**
```bash
# 1. Test key-pair authentication
snow connection test --account xy12345.us-east-1 --user YOUR_USERNAME --private-key-path rsa_key.pem

# 2. Check public key assignment
# In Snowsight:
DESC USER YOUR_USERNAME;
# Look for RSA_PUBLIC_KEY_FP value

# 3. Check browser console
# Open DevTools â†’ Console â†’ Look for JWT errors
```

---

### ğŸ”´ Error: 403 Forbidden

**Symptoms:**
- Authentication succeeds, but agent access denied

**Common Causes & Fixes:**

| Cause | How to Fix |
|-------|------------|
| **Missing role grants** | Run `GRANT USAGE ON DATABASE ... TO ROLE YOUR_ROLE;` |
| **Agent not accessible** | Check agent ownership and grants |
| **Schema access denied** | Grant `USAGE ON SCHEMA SFE_CORTEX_AGENT_CHAT` |

**Grant Required Permissions:**
```sql
USE ROLE ACCOUNTADMIN;

-- Grant database access
GRANT USAGE ON DATABASE SNOWFLAKE_EXAMPLE TO ROLE YOUR_ROLE;

-- Grant schema access
GRANT USAGE ON SCHEMA SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT TO ROLE YOUR_ROLE;

-- Grant agent usage
GRANT USAGE ON CORTEX AGENT SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT.SFE_REACT_DEMO_AGENT TO ROLE YOUR_ROLE;

-- Assign role to user
GRANT ROLE YOUR_ROLE TO USER YOUR_USERNAME;
```

---

### ğŸ”´ Error: 404 Not Found

**Symptoms:**
- API endpoint returns 404
- Agent name or schema not found

**Common Causes & Fixes:**

| Cause | How to Fix |
|-------|------------|
| **Agent doesn't exist** | Run `SHOW AGENTS;` to verify |
| **Wrong schema/database** | Check `.env.local` values match `deploy.sql` |
| **Case sensitivity** | Use exact names: `SFE_CORTEX_AGENT_CHAT` not `sfe_cortex_agent_chat` |

**Verify Objects Exist:**
```sql
-- Check database
SHOW DATABASES LIKE 'SNOWFLAKE_EXAMPLE';

-- Check schema
SHOW SCHEMAS IN DATABASE SNOWFLAKE_EXAMPLE;

-- Check agent
SHOW AGENTS IN SCHEMA SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT;
```

---

### ğŸ”´ Error: Invalid Private Key / JWT Token Invalid

**Symptoms:**
- Browser console: `JWT generation failed`
- API error: `JWT token is invalid`
- `Error: Invalid key format`

**Common Causes & Fixes:**

| Cause | How to Fix |
|-------|------------|
| **Incorrect newline escaping** | Private key must use literal `\n` (backslash-n) for line breaks |
| **Extra whitespace** | Copy entire key including BEGIN/END lines, no trailing spaces |
| **Wrong key format** | Use PKCS#8 (`BEGIN PRIVATE KEY`) not PKCS#1 (`BEGIN RSA PRIVATE KEY`) |
| **Corrupted key file** | Regenerate key-pair with `openssl genrsa` |
| **Setup script issue** | Manually fix the private key format (see below) |

**Correct `.env.local` Format:**
```env
# âœ… CORRECT - Single line with literal \n escape sequences
REACT_APP_SNOWFLAKE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhki...\n-----END PRIVATE KEY-----"

# âŒ WRONG - Multi-line (won't parse)
REACT_APP_SNOWFLAKE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhki...
-----END PRIVATE KEY-----"

# âŒ WRONG - Actual newlines instead of \n
REACT_APP_SNOWFLAKE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhki...
-----END PRIVATE KEY-----"
```

**Quick Fix (if setup script didn't format correctly):**
```bash
# Option 1: Run the fix script (easiest)
./tools/fix_private_key.sh

# Option 2: One-liner to fix .env.local
PRIVATE_KEY=$(awk 'NR>1{printf "\\n"}{printf "%s",$0}' rsa_key.pem)
sed -i.bak "s|REACT_APP_SNOWFLAKE_PRIVATE_KEY=.*|REACT_APP_SNOWFLAKE_PRIVATE_KEY=\"$PRIVATE_KEY\"|" .env.local

# Option 3: Manually copy and format
# 1. Open rsa_key.pem
# 2. Copy entire contents
# 3. Replace actual newlines with \n (backslash-n)
# 4. Paste as single line in .env.local
```

**Verify Format:**
```bash
# Check if private key has proper escaping
grep "REACT_APP_SNOWFLAKE_PRIVATE_KEY" .env.local | grep -o "\\\\n" | wc -l
# Should show a number > 0 (number of \n escape sequences)

# Or visually inspect
cat .env.local | grep PRIVATE_KEY
# Should see: REACT_APP_SNOWFLAKE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\nMIIEv...
```

---

### ğŸ”´ Error: CORS / Network Issues

**Symptoms:**
- Browser console: `CORS policy blocked`
- Network errors in DevTools

**Common Causes & Fixes:**

| Cause | How to Fix |
|-------|------------|
| **Browser security policy** | This is expected for local dev - use production deployment for real apps |
| **Account URL format** | Use `https://xy12345.snowflakecomputing.com` not custom domain |
| **Firewall blocking** | Check corporate firewall allows `*.snowflakecomputing.com` |

**Note:** CORS errors are common in local development. For production, deploy React app to same domain or configure Snowflake network policies.

---

### âœ… Quick Health Check

Run this checklist to verify everything is configured:

```bash
# â˜ Key-pair generated
ls -l rsa_key.pem rsa_key.pub

# â˜ Public key assigned to user
snow sql -q "DESC USER YOUR_USERNAME;" | grep RSA_PUBLIC_KEY_FP

# â˜ Agent exists
snow sql -q "SHOW AGENTS IN SCHEMA SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT;"

# â˜ Frontend env configured (non-secret)
grep REACT_APP .env.local

# â˜ Backend env has private key (not in frontend)
grep SNOWFLAKE_PRIVATE_KEY_PEM .env.server.local

# â˜ Connection test passes
snow connection test --account xy12345.us-east-1 --user YOUR_USERNAME --private-key-path rsa_key.pem
```

**If all checks pass and still having issues:**
1. Check browser console (DevTools â†’ Console)
2. Check Network tab for API request details
3. Review `deploy.sql` was run successfully
4. Verify role grants with `SHOW GRANTS TO USER YOUR_USERNAME;`

---

## Security Best Practices

### ğŸ”’ Critical Security Rules (NEVER VIOLATE)

| Rule | Why It Matters |
|------|----------------|
| âŒ **NEVER commit `.env.server.local`** | Contains private key (full account access) |
| âŒ **NEVER commit `.env.local`** | Environment config; keep non-secret only |
| âŒ **NEVER commit `*.pem` or `*.key` files** | Private keys grant permanent access |
| âŒ **NEVER share private keys** | Each user needs their own key-pair |
| âœ… **Store private keys securely** | Use password manager or secure vault |
| âœ… **Use 2048-bit RSA minimum** | Industry standard for security |
| âœ… **Rotate keys every 90 days** | Limit exposure window if compromised |
| âœ… **Restrict user roles** | Principle of least privilege |
| âœ… **Monitor audit logs** | Detect suspicious key usage |

### Key-Pair Authentication Benefits

**Compared to passwords or PAT tokens:**
- âœ… **Private key never transmitted** - Only JWT signatures sent over network
- âœ… **No expiring tokens** - Keys last until manually rotated
- âœ… **Auto-refreshing JWTs** - Transparent 1-hour token lifecycle
- âœ… **Asymmetric cryptography** - Public key can't generate valid tokens
- âœ… **No network policies needed** - Key-pair auth works from anywhere
- âœ… **Audit trail** - Snowflake logs all key-pair authentications

### Files Protected by `.gitignore`

```gitignore
# Automatically excluded (global ignore):
.env.server.local    # Backend secrets (private key)
.env.local           # Frontend config (non-secret)
.env                 # Any environment files
*.env                # All .env variants
*.pem                # RSA private keys
*.key                # Generic key files
rsa_key*             # Key-pair files
node_modules/        # Dependencies
build/               # Production builds
.DS_Store            # macOS metadata
```

### What Gets Committed (Safe)

```bash
âœ… env.example        # Template (no real keys)
âœ… deploy.sql         # SQL setup
âœ… src/               # React source code
âœ… README.md          # Documentation
âœ… .gitignore         # Security rules (for this project)
```

### Private Key Storage Options

**Development (Local Machine):**
```bash
# Option 1: Keep in project root (gitignored)
./rsa_key.pem

# Option 2: Separate secure directory
~/snowflake-keys/rsa_key.pem

# Option 3: System keychain (macOS)
security add-generic-password -s "snowflake-rsa-key" -a "$USER" -w "$(cat rsa_key.pem)"
```

**Production (Not Recommended):**
- This example is for local development only
- For production web apps, use server-side proxy with secure key storage
- Never expose private keys to browser environments in production

---

## Customization Guide

### Connect to Your Own Cortex Agent

Edit `.env.local` to point to your agent:

```env
# Your Snowflake details
REACT_APP_SNOWFLAKE_ACCOUNT=xy12345.us-east-1
REACT_APP_SNOWFLAKE_USER=your_username

# Your agent location
REACT_APP_SNOWFLAKE_DATABASE=YOUR_DATABASE
REACT_APP_SNOWFLAKE_SCHEMA=YOUR_SCHEMA
REACT_APP_CORTEX_AGENT_NAME=YOUR_AGENT_NAME

# Your key-pair (same as before)
REACT_APP_SNOWFLAKE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
```

**Restart app after changes:**
```bash
# Stop with Ctrl+C, then:
npm start
```

---

### Customize Snowflake Brand Colors

**Edit `src/App.css`:**
```css
:root {
  --sf-cyan: #29B5E8;          /* Primary - change to your brand color */
  --sf-cyan-dark: #1E88C7;     /* Darker shade for hover */
  --sf-cyan-light: #E3F5FC;    /* Light backgrounds */
  --sf-charcoal: #2D3E50;      /* Dark text */
  --sf-gray: #6B7785;          /* Secondary text */
  --sf-white: #FFFFFF;         /* Backgrounds */
}
```

All components use these CSS variables, so changes propagate automatically.

---

### Add New Features (Ideas)

**Easy Additions:**
- ğŸ’¾ **Message history persistence** - Use `localStorage` to save conversation
- ğŸŒ™ **Dark mode** - Add theme toggle with alternate color scheme
- ğŸ“‹ **Copy to clipboard** - Copy assistant responses with button
- ğŸ” **Search messages** - Filter conversation by keyword

**Medium Complexity:**
- ğŸ”„ **Multi-agent switching** - Dropdown to switch between agents
- ğŸ“Š **Markdown rendering** - Use `react-markdown` for formatted responses
- ğŸ“¥ **Export conversation** - Download as JSON or Markdown
- âŒ¨ï¸  **Keyboard shortcuts** - Ctrl+Enter to send, etc.

**Advanced:**
- ğŸ“ **File attachments** - Upload PDFs/images to agent
- ğŸ¤ **Voice input** - Speech-to-text for messages
- ğŸŒ **Multi-language** - i18n support for UI text
- ğŸ“ˆ **Analytics** - Track usage, response times

---

## Cleanup

### Complete Teardown (4 steps)

**Step 1: Stop React Application**
```bash
# In terminal running npm start:
# Press Ctrl+C to stop development server

# Optional: Remove dependencies
rm -rf node_modules
```

**Step 2: Remove Snowflake Objects**
```sql
-- Copy teardown.sql into Snowsight â†’ Run All

-- This removes:
-- âœ“ Schema: SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT
-- âœ“ Agent: SFE_REACT_DEMO_AGENT
-- âœ— Does NOT remove shared infrastructure (SNOWFLAKE_EXAMPLE database)
-- âœ— Does NOT remove public key from user (optional cleanup below)
```

**Step 3: Remove Public Key (Optional)**

Only needed if you won't use key-pair auth for other projects:

```sql
-- Unset public key from your user
USE ROLE ACCOUNTADMIN;
ALTER USER <your_username> UNSET RSA_PUBLIC_KEY;

-- Verify removal
DESC USER <your_username>;
-- RSA_PUBLIC_KEY_FP should be null
```

**Step 4: Securely Delete Private Key**

```bash
# Option 1: Secure deletion (Linux)
shred -u rsa_key.pem rsa_key.pub

# Option 2: Secure deletion (macOS)
rm -P rsa_key.pem rsa_key.pub

# Option 3: Manual deletion
rm rsa_key.pem rsa_key.pub
# Then clear clipboard and .env.local file
```

**Step 5: Remove Configuration**
```bash
# Delete local environment (contains private key)
rm .env.local

# Verify no secrets remain
grep -r "BEGIN PRIVATE KEY" .  # Should return nothing
```

---

### Partial Cleanup Options

**Keep Snowflake Objects, Remove Local Setup:**
```bash
# Just remove local files
rm -rf node_modules .env.local
rm rsa_key.pem rsa_key.pub
```

**Keep React App, Remove Agent:**
```sql
-- In Snowsight:
DROP CORTEX AGENT SNOWFLAKE_EXAMPLE.SFE_CORTEX_AGENT_CHAT.SFE_REACT_DEMO_AGENT;
```

**Reset to Fresh State:**
```bash
# Remove everything local
rm -rf node_modules .env.local rsa_key.pem rsa_key.pub

# Re-run setup from Step 1
npm install
# Generate new keys...
```

---

## Additional Resources

### Snowflake Documentation
- [Cortex Agents Overview](https://docs.snowflake.com/en/user-guide/snowflake-cortex/cortex-agents) - Feature introduction
- [Cortex Agent REST API](https://docs.snowflake.com/en/user-guide/snowflake-cortex/cortex-agents-rest-api) - API reference
- [Key-Pair Authentication Guide](https://docs.snowflake.com/en/user-guide/key-pair-auth) - Setup instructions
- [REST API Authentication](https://docs.snowflake.com/en/developer-guide/sql-api/authenticating) - JWT token format

### Technical References
- [React.js Documentation](https://reactjs.org/docs) - React framework guide
- [Express.js](https://expressjs.com/) - Backend proxy framework
- [OpenSSL Documentation](https://www.openssl.org/docs/) - Key generation commands
- [Server-Sent Events (SSE)](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events) - Streaming protocol

### Related Tools
- [Snowflake Python Connector](https://docs.snowflake.com/en/developer-guide/python-connector/python-connector) - Alternative to REST API
- [Streamlit + Cortex Agents](https://docs.snowflake.com/en/developer-guide/streamlit/about-streamlit) - Native Snowflake UI
- [Snow CLI](https://docs.snowflake.com/en/developer-guide/snowflake-cli/overview) - Command-line tooling

---

## License & Attribution

**Author:** SE Community  
**Created:** 2025-12-15  
**Expires:** 2026-01-14 (30 days)  
**Status:** Active Reference Implementation

**Reference Implementation Notice:**  
This code demonstrates production-grade architectural patterns and best practices for integrating React.js with Snowflake Cortex Agents. Review and customize security, authentication, and error handling for your organization's specific requirements before production deployment.

**âš ï¸ Important:**
- This is a development example - not production-ready
- Private keys in browser environments are for local dev only
- For production, use server-side proxy with secure key storage
- Review Snowflake's security best practices before deployment

---

**Questions or Issues?**  
This is a reference implementation maintained by the Snowflake SE Community. For production support, consult Snowflake documentation or your account team.

---

*Last Updated: 2025-12-15 | Next Review: 2026-01-14 | Version: 1.0*
